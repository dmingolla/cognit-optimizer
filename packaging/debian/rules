#!/usr/bin/make -f

export DH_VERBOSE=1

%:
	dh $@

override_dh_auto_build:
	# Create Python virtual environment with dependencies
	python3 -m venv debian/python-venv
	debian/python-venv/bin/pip install --upgrade pip
	debian/python-venv/bin/pip install -r requirements.txt
	# Install vendored pyoneai package
	debian/python-venv/bin/pip install ./vendor-pyoneai/

override_dh_auto_install:
	# Create installation directories
	mkdir -p debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer
	mkdir -p debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer/modules
	mkdir -p debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer/device_alloc
	mkdir -p debian/opennebula-cognit-optimizer/usr/share/one/cognit-optimizer
	mkdir -p debian/opennebula-cognit-optimizer/etc/one
	mkdir -p debian/opennebula-cognit-optimizer/lib/systemd/system
	mkdir -p debian/opennebula-cognit-optimizer/etc/logrotate.d
	
	# Install Python source files
	cp -a main.py debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer/
	cp -a modules/*.py debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer/modules/
	cp -a device_alloc/*.py debian/opennebula-cognit-optimizer/usr/lib/one/cognit-optimizer/device_alloc/
	
	# Install Python venv
	cp -a debian/python-venv debian/opennebula-cognit-optimizer/usr/share/one/cognit-optimizer/python-venv
	
	# Install configuration
	cp -a share/etc/cognit-optimizer.conf debian/opennebula-cognit-optimizer/etc/one/
	
	# Install systemd service
	cp -a packaging/systemd/opennebula-cognit-optimizer.service debian/opennebula-cognit-optimizer/lib/systemd/system/
	
	# Install logrotate
	cp -a packaging/logrotate/opennebula-cognit-optimizer debian/opennebula-cognit-optimizer/etc/logrotate.d/

override_dh_auto_clean:
	dh_auto_clean
	rm -rf debian/python-venv

override_dh_installinit:
	dh_installinit --name=opennebula-cognit-optimizer

override_dh_systemd_enable:
	dh_systemd_enable --name=opennebula-cognit-optimizer

override_dh_systemd_start:
	dh_systemd_start --name=opennebula-cognit-optimizer

